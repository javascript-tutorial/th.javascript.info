# ตัวดำเนินการรวม Nullish '??'

[recent browser="new"]

ตัวดำเนินการรวม nullish เขียนด้วยเครื่องหมายคำถามสองตัวติดกัน `??` 

ในบทความนี้เราจะใช้ศัพท์เฉพาะ เนื่องจาก `null` และ `undefined` ถูกจัดการในลักษณะคล้ายกัน เพื่อให้กระชับ เราจะเรียกว่าค่าหนึ่ง "ถูกกำหนด" เมื่อไม่ใช่ทั้ง `null` และ `undefined`

ผลลัพธ์ของ `a ?? b` จะเป็น:
- ถ้า `a` ถูกกำหนด ผลลัพธ์คือ `a`
- ถ้า `a` ไม่ถูกกำหนด ผลลัพธ์คือ `b`

อีกนัยหนึ่ง `??` จะคืนอาร์กิวเมนต์ตัวแรก ถ้าไม่ใช่ `null/undefined` ไม่เช่นนั้นจะคืนตัวที่สอง

ตัวดำเนินการรวม nullish ไม่ใช่เรื่องใหม่ เป็นเพียงไวยากรณ์ที่สะดวกในการหาค่าแรกที่ "ถูกกำหนด" จากสองค่า

เราสามารถเขียน `result = a ?? b` ใหม่โดยใช้ตัวดำเนินการที่คุ้นเคยแล้วได้ดังนี้:

```js
result = (a !== null && a !== undefined) ? a : b;
```

ตอนนี้น่าจะชัดเจนแล้วว่า `??` ทำอะไร มาดูกันว่ามันมีประโยชน์อย่างไรบ้าง

กรณีใช้งานทั่วไปของ `??` คือการกำหนดค่าเริ่มต้น (default)

ตัวอย่างเช่น ตรงนี้เราจะแสดง `user` ถ้าค่าไม่ใช่ `null/undefined` ไม่อย่างนั้นจะแสดง `Anonymous`:

```js run
let user;

alert(user ?? "Anonymous"); // Anonymous (user เป็น undefined)
```

นี่คือตัวอย่างที่กำหนด `user` เป็นชื่อ:

```js run
let user = "John";

alert(user ?? "Anonymous"); // John (user ไม่ใช่ null/undefined)
```

เรายังสามารถใช้ `??` หลายตัวต่อกัน เพื่อเลือกค่าแรกจาก list ที่ไม่ใช่ `null/undefined` ได้ด้วย

สมมติเรามีข้อมูลผู้ใช้ในตัวแปร `firstName`, `lastName` หรือ `nickName` ซึ่งอาจไม่ถูกกำหนดค่า หากผู้ใช้ไม่ได้กรอกข้อมูลที่เกี่ยวข้อง

เราต้องการแสดงชื่อผู้ใช้จากตัวแปรเหล่านี้ตัวใดตัวหนึ่ง หรือแสดง "Anonymous" ถ้าทุกตัวเป็น `null/undefined`

มาใช้ตัวดำเนินการ `??` กันเลย:

```js run
let firstName = null;
let lastName = null;
let nickName = "Supercoder";

// แสดงค่าแรกที่ถูกกำหนด:
*!*
alert(firstName ?? lastName ?? nickName ?? "Anonymous"); // Supercoder
*/!*  
```

## เปรียบเทียบกับ ||

ตัวดำเนินการ OR `||` สามารถใช้ได้ในทำนองเดียวกับ `??` ตามที่อธิบายไว้ใน[บทก่อนหน้า](info:logical-operators#or-finds-the-first-truthy-value)

เช่น ในโค้ดข้างต้น เราสามารถแทนที่ `??` ด้วย `||` โดยยังได้ผลลัพธ์เหมือนเดิม:

```js run
let firstName = null;
let lastName = null;
let nickName = "Supercoder";

// แสดงค่า truthy ตัวแรก:
*!*
alert(firstName || lastName || nickName || "Anonymous"); // Supercoder
*/!*
```

ย้อนไปในอดีต ตัวดำเนินการ OR `||` มีมาก่อนตั้งแต่ JavaScript เริ่มต้น นักพัฒนาจึงใช้มันเพื่อวัตถุประสงค์แบบนี้มานาน

ในทางกลับกัน ตัวดำเนินการรวม nullish `??` เพิ่งถูกเพิ่มเข้ามาใน JavaScript ไม่นานมานี้ สาเหตุเพราะคนไม่ค่อยพอใจกับ `||` นัก

ความแตกต่างสำคัญระหว่างสองตัวนี้คือ:
- `||` คืนค่า *truthy* ตัวแรก  
- `??` คืนค่าแรกที่ *ถูกกำหนด*

อีกนัยหนึ่ง `||` ไม่ได้แยกความแตกต่างระหว่าง `false`, `0`, string ว่าง `""` และ `null/undefined` มันถือว่าทั้งหมดเป็นค่า falsy เหมือนกัน ถ้าตัวใดตัวหนึ่งเป็น argument ตัวแรกของ `||` เราจะได้ argument ตัวที่สองเป็นผลลัพธ์

แต่ในทางปฏิบัติ เราอาจต้องการใช้ค่าเริ่มต้นก็ต่อเมื่อตัวแปรเป็น `null/undefined` นั่นคือเมื่อไม่รู้ค่าจริงๆ/ไม่ได้ถูกกำหนด

ตัวอย่างเช่น พิจารณาโค้ดนี้:

```js run
let height = 0;

alert(height || 100); // 100
alert(height ?? 100); // 0
```

- `height || 100` ตรวจสอบว่า `height` เป็นค่า falsy หรือไม่ ซึ่ง `0` ก็ถือเป็น falsy จริงๆ
    - ดังนั้นผลลัพธ์ของ `||` คือ argument ตัวที่สอง `100`
- `height ?? 100` ตรวจสอบว่า `height` เป็น `null/undefined` หรือไม่ ซึ่งไม่ใช่
    - ดังนั้นผลลัพธ์คือ `height` "ตามที่เป็น" คือ `0`

ในทางปฏิบัติ ความสูงเป็นศูนย์มักเป็นค่าที่ถูกต้อง ไม่ควรถูกแทนที่ด้วยค่าเริ่มต้น ดังนั้น `??` จึงให้ผลลัพธ์ที่ถูกต้องพอดี

## ลำดับความสำคัญ

ตัวดำเนินการ `??` มีลำดับความสำคัญเท่ากับ `||` ทั้งคู่มีค่าเท่ากับ `3` ในตาราง [MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Operator_Precedence#Table)

นั่นหมายความว่า เช่นเดียวกับ `||` ตัวดำเนินการรวม nullish `??` จะถูกประเมินก่อน `=` และ `?` แต่หลังการดำเนินการอื่นๆ ส่วนใหญ่ เช่น `+`, `*`

ดังนั้นในนิพจน์แบบนี้ เราอาจต้องใส่วงเล็บเพิ่ม:

```js run
let height = null;
let width = null;

// สำคัญ: ใช้วงเล็บ
let area = (height ?? 100) * (width ?? 50);

alert(area); // 5000
```

ไม่เช่นนั้น ถ้าเราละวงเล็บ เนื่องจาก `*` มีลำดับความสำคัญสูงกว่า `??` มันจะถูกประเมินก่อน ทำให้ได้ผลลัพธ์ไม่ถูกต้อง

```js
// ไม่มีวงเล็บ
let area = height ?? 100 * width ?? 50;

// ...ทำงานแบบนี้ (ไม่ใช่สิ่งที่เราต้องการ):
let area = height ?? (100 * width) ?? 50;
```

### การใช้ ?? ร่วมกับ && หรือ ||

ด้วยเหตุผลด้านความปลอดภัย JavaScript ไม่อนุญาตให้ใช้ `??` ร่วมกับตัวดำเนินการ `&&` และ `||` นอกจากจะระบุลำดับความสำคัญชัดเจนด้วยวงเล็บ

โค้ดด้านล่างจะทำให้เกิด syntax error:

```js run
let x = 1 && 2 ?? 3; // Syntax error
```

ข้อจำกัดนี้อาจโต้แย้งได้ แต่ถูกเพิ่มเข้ามาในข้อกำหนดภาษา เพื่อหลีกเลี่ยงข้อผิดพลาดในการเขียนโปรแกรม เมื่อคนเริ่มเปลี่ยนจาก `||` มาใช้ `??`  

ใช้วงเล็บให้ชัดเจนเพื่อแก้ปัญหา:

```js run
*!*
let x = (1 && 2) ?? 3; // ใช้ได้
*/!*

alert(x); // 2
```

## สรุป

- ตัวดำเนินการรวม nullish `??` ให้วิธีที่กระชับในการเลือกค่าแรกที่ "ถูกกำหนด" จาก list

  มันมักถูกใช้เพื่อกำหนดค่าเริ่มต้นให้ตัวแปร:

  ```js
  // กำหนด height=100 ถ้า height เป็น null หรือ undefined
  height = height ?? 100;
  ```

- ตัวดำเนินการ `??` มีลำดับความสำคัญต่ำมาก สูงกว่า `?` และ `=` เพียงเล็กน้อย ดังนั้นควรใส่วงเล็บเมื่อใช้ในนิพจน์
- ห้ามใช้ร่วมกับ `||` หรือ `&&` โดยไม่ใส่วงเล็บให้ชัดเจน